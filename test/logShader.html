<link rel="stylesheet" href="../grid.css">

<script type="module">
  import * as THREE from '../lib/three.module.js';
  import * as MeshDemo from './meshDemo.js';


  const vert = /* glsl */ `
    out vec2 v_pos;

    void main() {
      v_pos = position.xy;
      
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
  `;

  const frag = /* glsl */ `
    #define PI 3.14159265359

    in vec2 v_pos;

    out vec3 outColor;

    uniform vec3 color;
    uniform float strokeWidth;
    uniform int logType;

    const float LOG_WIDTH = 0.4;

    void main() {

      float distY = abs( v_pos.y );
      float leftDistX = -0.5 + v_pos.y * v_pos.y - v_pos.x;
      float rightDistX = 0.5 - v_pos.y * v_pos.y - v_pos.x;
     
      if ( distY < LOG_WIDTH && (
           ( logType == 0 && leftDistX < -strokeWidth ) || 
           ( logType == 1 ) || 
           ( logType == 2 && rightDistX > strokeWidth )
         ) ) {
        outColor = mix( vec3( 0.0 ), color, cos( PI * distY ) );
      }
      else if ( distY < LOG_WIDTH + strokeWidth && (
           ( logType == 0 && leftDistX < 0.0 ) || 
           ( logType == 1 ) || 
           ( logType == 2 && rightDistX > 0.0 )
        ) ) {
        outColor = vec3( 0.0 );
      }
      else {
        discard;
      }
    }
  `;


  let animationTime = 0;

  const logs = [ 0, 1, 2 ].map( logType => new THREE.Mesh(
    new THREE.PlaneGeometry( 1, 1 ),
    new THREE.ShaderMaterial( {
      uniforms: {
        color: { value: new THREE.Vector3( 0.5, 0.25, 0.05 ) },
        strokeWidth: { value: 0.02 },
        logType: { value: logType },
      },
      vertexShader: vert,
      fragmentShader: frag,
      glslVersion: THREE.GLSL3,
    } ),
  ) );

  logs[ 0 ].position.x = -1;
  logs[ 2 ].position.x = 1;

  const group = new THREE.Group();
  group.add( ...logs );
    
  MeshDemo.meshDemo( 
    group, 
    ( dt ) => {
      animationTime += dt / 500;

      logs.forEach( ( log, index ) => log.position.x = index - 1 + Math.sin( animationTime ) );
    }
  );

</script>
