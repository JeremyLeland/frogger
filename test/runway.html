<title>Runway</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { AnimatedCanvas } from '../src/common/AnimatedCanvas.js';

  const circlePath = new Path2D( 'M -0.5,0 A 0.5,0.5 0,0,1 0.5,0 A 0.5,0.5 0,0,1 -0.5,0' );
  const pupilPath = new Path2D( 'M -0.3,-0.3 A 0.3,0.2 0,0,1 0.3,-0.3 A 0.3,0.2 0,0,1 -0.3,-0.3' );

  const frog = {
    leftFoot: {
      t: [ -0.5, -0.5 ],
      s: 0.2,
      f: 'green',
      p: new Path2D( 'M -0.2,0.4 L -0.5,0 A 0.5,0.3 0,0,1 0.5,0 L 0.2,0.4 Z' ),
    },
    body: {
      f: 'green',
      p: circlePath,
    },
    leftEye: {
      t: [ -0.2, -0.2 ],
      s: 0.25,
      f: 'white',
      p: circlePath,
    },
    leftPupil: {
      t: [ -0.2, -0.2 ],
      s: 0.25,
      f: 'black',
      p: pupilPath,
    },
    rightEye: {
      t: [ 0.2, -0.2 ],
      s: 0.25,
      f: 'white',
      p: circlePath,
    },
    rightPupil: {
      t: [ 0.2, -0.2 ],
      s: 0.25,
      f: 'black',
      p: pupilPath,
    },
  };


  const canvas = new AnimatedCanvas();

  let frogTime = 0;

  canvas.update = ( dt ) => {
    frogTime += dt;
  }

  canvas.draw = ( ctx ) => {

    // Grass
    // ctx.fillStyle = 'darkgreen';
    // ctx.fillRect( 0, 0, 640, 640 );

    // Bush

    // Road
    // drawRoad( ctx, new Path2D( 'M 32,32 L 320,32 Q 352,32 352,64 L 352,320' ) );

    // Sidewalk

    // Car

    // Water
    // ctx.fillStyle = 'darkblue';
    // ctx.fillRect( 32, 128, 256, 320 );

    // // Log
    // drawLog( ctx, new Path2D( 'M 32,128 L 160,128' ) );

    // Turtle

    // Lilypad

    // Frog
    drawFrog( ctx );

    ctx.translate( 620, 160 );
    ctx.scale( 128, 128 );

    drawEntity( ctx, frog );
  };

  // canvas.redraw();
  canvas.start();

  function drawRoad( ctx, path ) {
    ctx.save();

    ctx.strokeStyle = 'gray';
    ctx.lineWidth = 64;
    ctx.lineCap = 'square';
    ctx.stroke( path );

    ctx.strokeStyle = 'yellow';
    ctx.lineWidth = 4;
    ctx.lineCap = 'butt';
    ctx.setLineDash( [ 16, 16 ] );
    ctx.stroke( path );

    ctx.restore();
  }

  function drawLog( ctx, path ) {
    ctx.save();

    ctx.strokeStyle = 'brown';
    ctx.lineWidth = 32;
    ctx.lineCap = 'round';
    ctx.stroke( path );

    ctx.strokeStyle = 'black';
    ctx.lineWidth = 1;
    ctx.lineCap = 'butt';
    ctx.setLineDash( [ 8, 16, 8, 32, 8, 64 ] );
    ctx.stroke( path );

    ctx.restore();
  }



  function drawEntity( ctx, info ) {
    for ( const name in info ) {
      const item = info[ name ];

      ctx.save();

      if ( item.t )   ctx.translate( ...item.t );
      if ( item.s )   ctx.scale( item.s, item.s );

      if ( item.f )   ctx.fillStyle = item.f;
      if ( item.p ) {
        ctx.fill( item.p );
        ctx.lineWidth = 1 / ctx.getTransform().m11;
        ctx.stroke( item.p );
      }

      // TODO: children?

      ctx.restore();
    }
  }

  function drawFrog( ctx ) {
    ctx.save();
    ctx.translate( 320, 160 );
    ctx.scale( 128, 128 );

    const body = new Path2D();
    body.arc( 0, 0, 0.5, 0, Math.PI * 2 );

    drawPath( ctx, body, 'green' );

    const sclera = new Path2D();
    sclera.arc( -0.2, -0.2, 0.125, 0, Math.PI * 2 );
    sclera.moveTo( 0.2 + 0.125, -0.2 );
    sclera.arc(  0.2, -0.2, 0.125, 0, Math.PI * 2 );

    drawPath( ctx, sclera, 'white' );

    const pupils = new Path2D();
    pupils.ellipse( -0.2, -0.27, 0.1, 0.06, 0, 0, Math.PI * 2 );
    pupils.moveTo(  0.2 + 0.1, -0.27 );
    pupils.ellipse(  0.2, -0.27, 0.1, 0.06, 0, 0, Math.PI * 2 );

    drawPath( ctx, pupils, 'black' );

    const leg = new Path2D();

    // TODO: Animate!

    const footDist = -0.4 - 0.1 * Math.cos( 0.01 * frogTime );

    [ -1, 1 ].forEach( side => {
      leg.lineTo( side * 0.3, 0 );
      leg.quadraticCurveTo( side * 0.5, 0, side * 0.55, footDist );
      leg.lineTo( side * 0.6, footDist - 0.1 );
      leg.quadraticCurveTo( side * 0.5, footDist - 0.2, side * 0.4, footDist - 0.1 );
      leg.lineTo( side * 0.45, footDist );
      leg.quadraticCurveTo( side * 0.4, -0.1, side * 0.3, -0.2 );
    } );

    leg.closePath();

    drawPath( ctx, leg, 'green' );

    ctx.restore();
  }

  function drawPath( ctx, path, fillStyle = 'red', strokeStyle = 'black' ) {
    ctx.fillStyle = fillStyle;
    ctx.beginPath();
    ctx.arc( 0, 0, 0.5, 0, Math.PI * 2 );
    ctx.fill( path );
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = 1 / ctx.getTransform().m11;
    ctx.stroke( path );
  }

</script>