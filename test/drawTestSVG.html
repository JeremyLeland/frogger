<title>SVG drawing tests</title>
<link rel="stylesheet" href="../ui.css">

<label for="count">Count:</label>
<input type="range" id="count" name="count" min="0" max="1000" value="2"/>
<label for="rasterize">Rasterize:</label>
<input type="checkbox" id="rasterize" name="rasterize" />

<script type="module">
  import { AnimatedCanvas } from '../src/common/AnimatedCanvas.js';

  const entities = [];

  function setCount( count ) {
    entities.splice( count );

    for ( let i = entities.length; i < count; i ++ ) {
      entities.push(
        {
          x: Math.floor( Math.random() * 1000 ),
          y: Math.floor( Math.random() * 1000 ), 
          angle: Math.random() * 360
          // angle: Math.random() * 6
        }
      );
    }
  }

  const svgImage = new Image();
  svgImage.src = './SNice.svg';
  await svgImage.decode();

  const rasterImage = new OffscreenCanvas( 50, 50 );
  rasterImage.getContext( '2d' ).drawImage( svgImage, 0, 0 );
  
  let toDraw;

  const rasterizeUI = document.getElementById( 'rasterize' );
  rasterizeUI.addEventListener( 'change', _ => toDraw = rasterizeUI.checked ? rasterImage : svgImage );
  rasterizeUI.dispatchEvent( new Event( 'change' ) );

  const countUI = document.getElementById( 'count' );
  countUI.addEventListener( 'input', _ => setCount( countUI.valueAsNumber ) );  
  countUI.dispatchEvent( new Event( 'input' ) );

  const canvas = new AnimatedCanvas();

  canvas.update = ( dt ) => {
    entities.forEach( e => {
      e.angle += dt / 1000;
    } );
  }

  canvas.draw = ( ctx ) => {
    ctx.clearRect( 0, 0, ctx.canvas.width, ctx.canvas.height );

    ctx.save();
    // ctx.scale( 10, 10 );

    entities.forEach( e => {
      ctx.save(); {

        ctx.translate( e.x, e.y );
        ctx.rotate( e.angle );
        
        ctx.drawImage( toDraw, 0, 0 ); 
      }
      ctx.restore();
    } );

    ctx.restore();
  };

  canvas.start();

</script>